{% extends "base.html" %}

{% block title %}Live Performance - Bitcoin Price Prediction{% endblock %}

{% block content %}
<div class="page-header">
    <h1>‚õìÔ∏è Blockchain-Verified Predictions</h1>
    <p class="page-subtitle">Real-world performance with immutable on-chain proof</p>
</div>

{% if demo_mode %}
<div class="demo-banner">
    üìä Demo Mode: Showing 30-day historical performance with realistic prediction
</div>
{% endif %}

<!-- Current Bitcoin Price -->
<section class="live-status-section">
    <h2>Current Bitcoin Price</h2>
    <div class="live-price-card">
        <div class="price-display">
            <span class="price-label">BTC/USD</span>
            <span class="price-value" id="currentPrice">${{ "{:,.2f}".format(summary.current_price) }}</span>
            <span class="price-timestamp">Last updated: {{ summary.timestamp }}</span>
        </div>
    </div>
</section>

<!-- Performance Summary -->
<section class="performance-summary">
    <h2>üìä 30-Day Performance Summary</h2>
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon">üìà</div>
            <div class="metric-value">{{ "%.2f"|format(summary.avg_mape_1d) }}%</div>
            <div class="metric-label">Avg MAPE (1-Day)</div>
            <div class="metric-sublabel">
                Test: 1.53% |
                {% if summary.avg_mape_1d < 2 %}
                    <span class="status-good">‚úÖ Excellent</span>
                {% elif summary.avg_mape_1d < 3 %}
                    <span class="status-ok">‚ö†Ô∏è Good</span>
                {% else %}
                    <span class="status-poor">‚ùå Poor</span>
                {% endif %}
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">üéØ</div>
            <div class="metric-value">{{ "%.1f"|format(summary.directional_accuracy_1d) }}%</div>
            <div class="metric-label">Directional Accuracy</div>
            <div class="metric-sublabel">Test: 51.4% | Live: {{ "%.1f"|format(summary.directional_accuracy_1d) }}%</div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">‚õìÔ∏è</div>
            <div class="metric-value">{{ summary.total_predictions }}</div>
            <div class="metric-label">Total Predictions</div>
            <div class="metric-sublabel">{{ summary.predictions_with_outcomes_1d }} with outcomes</div>
        </div>

        {% if summary.best_prediction_1d %}
        <div class="metric-card">
            <div class="metric-icon">üèÜ</div>
            <div class="metric-value">{{ "%.2f"|format(summary.best_prediction_1d.mape_1d) }}%</div>
            <div class="metric-label">Best Prediction</div>
            <div class="metric-sublabel">{{ summary.best_prediction_1d.date }}</div>
        </div>
        {% endif %}
    </div>
</section>

<!-- Blockchain Predictions Table -->
<section class="blockchain-section">
    <h2>‚õìÔ∏è Blockchain-Verified Predictions (Last 30 Days)</h2>

    <div class="table-container">
        <table class="predictions-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Horizon</th>
                    <th>Current $</th>
                    <th>Predicted $</th>
                    <th>Actual $</th>
                    <th>Error $</th>
                    <th>MAPE %</th>
                    <th>Direction</th>
                    <th>TX Hash</th>
                </tr>
            </thead>
            <tbody>
            {% for pred in blockchain_predictions|reverse %}
                <!-- 1-Day Row -->
                {% set row_class = 'success' if pred.mape_1d and pred.mape_1d < 2 else 'warning' if pred.mape_1d and pred.mape_1d < 5 else 'error' if pred.mape_1d else 'pending' %}
                <tr class="{{ row_class }}">
                    <td>{{ pred.date }}</td>
                    <td class="horizon"><strong>1-Day</strong></td>
                    <td>${{ "{:,.2f}".format(pred.current_price) }}</td>
                    <td>${{ "{:,.2f}".format(pred.pred_1d) }}</td>
                    <td>
                        {% if pred.actual_1d and not (pred.actual_1d != pred.actual_1d) %}
                            ${{ "{:,.2f}".format(pred.actual_1d) }}
                        {% else %}
                            <span class="pending">Pending...</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if pred.error_1d and not (pred.error_1d != pred.error_1d) %}
                            ${{ "{:,.2f}".format(pred.error_1d) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if pred.mape_1d and not (pred.mape_1d != pred.mape_1d) %}
                            {{ "%.2f"|format(pred.mape_1d) }}%
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="direction">
                        {% if pred.direction_correct_1d == 1 or pred.direction_correct_1d == True %}
                            <span class="correct">‚úì</span>
                        {% elif pred.direction_correct_1d == 0 or pred.direction_correct_1d == False %}
                            <span class="incorrect">‚úó</span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="tx-hash">
                        <a href="https://moonbase.moonscan.io/tx/{{ pred.tx_hash }}" target="_blank" title="{{ pred.tx_hash }}">
                            {{ pred.tx_hash[:10] }}...
                        </a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<!-- Chart Section -->
<section class="chart-section">
    <h2>üìà Predicted vs Actual Prices (Last 30 Days)</h2>
    <div id="chart-status" style="padding: 10px; margin-bottom: 15px; background: #e3f2fd; border-radius: 5px; display: none;"></div>
    <canvas id="predictionChart" width="400" height="150"></canvas>
</section>

<!-- Blockchain Verification Panel -->
<section class="blockchain-info">
    <h2>‚õìÔ∏è Blockchain Verification</h2>
    <div class="info-grid">
        <div class="info-card">
            <div class="info-label">Smart Contract</div>
            <div class="info-value">
                <a href="https://moonbase.moonscan.io/address/{{ contract_address }}" target="_blank">
                    {{ contract_address[:10] }}...{{ contract_address[-8:] }}
                </a>
            </div>
        </div>
        <div class="info-card">
            <div class="info-label">Network</div>
            <div class="info-value">Moonbase Alpha (Testnet)</div>
        </div>
        <div class="info-card">
            <div class="info-label">Total Gas Used</div>
            <div class="info-value">
                {% set total_gas = blockchain_predictions|sum(attribute='gas_used', start=0) %}
                {{ "{:,}".format(total_gas|int) }}
            </div>
        </div>
        <div class="info-card">
            <div class="info-label">Explorer</div>
            <div class="info-value">
                <a href="https://moonbase.moonscan.io" target="_blank">Moonscan</a>
            </div>
        </div>
    </div>
</section>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function() {
    'use strict';
    
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChart);
    } else {
        initChart();
    }
    
    function initChart() {
        console.log('Initializing chart...');
        
        // Helper function to show status
        function showStatus(message, isError) {
            const statusDiv = document.getElementById('chart-status');
            if (statusDiv) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = isError ? '#f8d7da' : '#d4edda';
                statusDiv.style.color = isError ? '#721c24' : '#155724';
                statusDiv.innerHTML = message;
            }
            console.log(message);
        }
        
        // Check if Chart.js is loaded
        if (typeof Chart === 'undefined') {
            showStatus('‚ùå Chart.js library not loaded', true);
            return;
        }
        
        showStatus('Loading chart data...');
        
        // Fetch data from backend
        fetch('/api/blockchain-predictions')
            .then(function(response) {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                console.log('Data received:', data);
                
                // Validate response structure
                if (!data || data.status !== 'success') {
                    throw new Error('Invalid API response status');
                }
                
                if (!data.predictions || !Array.isArray(data.predictions)) {
                    throw new Error('No predictions array in response');
                }
                
                console.log('Total predictions:', data.predictions.length);
                
                // Filter predictions that have actual outcomes
                var validPredictions = [];
                for (var i = 0; i < data.predictions.length; i++) {
                    var pred = data.predictions[i];
                    // Check if actual_1d exists and is a valid number
                    if (pred.actual_1d !== null && 
                        pred.actual_1d !== undefined && 
                        pred.actual_1d !== '' &&
                        typeof pred.actual_1d === 'number' &&
                        !isNaN(pred.actual_1d)) {
                        validPredictions.push(pred);
                    }
                }
                
                console.log('Valid predictions with outcomes:', validPredictions.length);
                
                if (validPredictions.length === 0) {
                    showStatus('‚ö†Ô∏è No predictions with outcomes available yet', true);
                    return;
                }
                
                // Extract data for chart
                var labels = [];
                var predictedData = [];
                var actualData = [];
                
                for (var i = 0; i < validPredictions.length; i++) {
                    var p = validPredictions[i];
                    labels.push(p.date || 'Unknown');
                    predictedData.push(Number(p.pred_1d) || 0);
                    actualData.push(Number(p.actual_1d) || 0);
                }
                
                console.log('Chart data prepared:', {
                    labels: labels.length,
                    predicted: predictedData.length,
                    actual: actualData.length
                });
                
                showStatus('Creating chart with ' + validPredictions.length + ' data points...');
                
                // Get canvas element
                var canvas = document.getElementById('predictionChart');
                if (!canvas) {
                    throw new Error('Canvas element not found');
                }
                
                var ctx = canvas.getContext('2d');
                if (!ctx) {
                    throw new Error('Could not get canvas context');
                }
                
                // Create chart
                var chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Predicted (1d)',
                                data: predictedData,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                borderWidth: 2,
                                tension: 0.1,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            },
                            {
                                label: 'Actual',
                                data: actualData,
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                borderWidth: 2,
                                tension: 0.1,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: '1-Day Predictions vs Reality',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        var label = context.dataset.label || '';
                                        var value = context.parsed.y;
                                        return label + ': $' + value.toLocaleString('en-US', {
                                            minimumFractionDigits: 2,
                                            maximumFractionDigits: 2
                                        });
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Price (USD)',
                                    font: { size: 14, weight: 'bold' }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date',
                                    font: { size: 14, weight: 'bold' }
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
                
                showStatus('‚úÖ Chart created successfully with ' + validPredictions.length + ' data points!');
                console.log('Chart instance created:', chart);
            })
            .catch(function(error) {
                showStatus('‚ùå Error: ' + error.message, true);
                console.error('Chart error:', error);
            });
    }
})();
</script>

{% endblock %}
