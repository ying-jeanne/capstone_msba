{% extends "base.html" %}

{% block title %}Live Performance - Bitcoin Price Prediction{% endblock %}

{% block content %}
<div class="page-header">
    <h1>‚õìÔ∏è Blockchain-Verified Predictions</h1>
    <p class="page-subtitle">Real-world performance with immutable on-chain proof</p>
</div>

{% if demo_mode %}
<div class="demo-banner">
    üìä Demo Mode: Showing 30-day historical performance with synthetic but realistic predictions
</div>
{% endif %}

<!-- Current Bitcoin Price -->
<section class="live-status-section">
    <h2>Current Bitcoin Price</h2>
    <div class="live-price-card">
        <div class="price-display">
            <span class="price-label">BTC/USD</span>
            <span class="price-value" id="currentPrice">${{ "{:,.2f}".format(summary.current_price) }}</span>
            <span class="price-timestamp">Last updated: {{ summary.timestamp }}</span>
        </div>
    </div>
</section>

<!-- Performance Summary -->
<section class="performance-summary">
    <h2>üìä 30-Day Performance Summary</h2>
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon">üìà</div>
            <div class="metric-value">{{ "%.2f"|format(summary.avg_mape_1d) }}%</div>
            <div class="metric-label">Avg MAPE (1-Day)</div>
            <div class="metric-sublabel">
                Test: 1.53% |
                {% if summary.avg_mape_1d < 2 %}
                    <span class="status-good">‚úÖ Excellent</span>
                {% elif summary.avg_mape_1d < 3 %}
                    <span class="status-ok">‚ö†Ô∏è Good</span>
                {% else %}
                    <span class="status-poor">‚ùå Poor</span>
                {% endif %}
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">üéØ</div>
            <div class="metric-value">{{ "%.1f"|format(summary.directional_accuracy_1d) }}%</div>
            <div class="metric-label">Directional Accuracy</div>
            <div class="metric-sublabel">Test: 51.4% | Live: {{ "%.1f"|format(summary.directional_accuracy_1d) }}%</div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">‚õìÔ∏è</div>
            <div class="metric-value">{{ summary.total_predictions }}</div>
            <div class="metric-label">Total Predictions</div>
            <div class="metric-sublabel">{{ summary.predictions_with_outcomes_1d }} with outcomes</div>
        </div>

        {% if summary.best_prediction_1d %}
        <div class="metric-card">
            <div class="metric-icon">üèÜ</div>
            <div class="metric-value">{{ "%.2f"|format(summary.best_prediction_1d.mape_1d) }}%</div>
            <div class="metric-label">Best Prediction</div>
            <div class="metric-sublabel">{{ summary.best_prediction_1d.date }}</div>
        </div>
        {% endif %}
    </div>
</section>

<!-- Blockchain Predictions Table -->
<section class="blockchain-section">
    <h2>‚õìÔ∏è Blockchain-Verified Predictions (Last 30 Days)</h2>

    <div class="table-container">
        <table class="predictions-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Horizon</th>
                    <th>Current $</th>
                    <th>Predicted $</th>
                    <th>Actual $</th>
                    <th>Error $</th>
                    <th>MAPE %</th>
                    <th>Direction</th>
                    <th>TX Hash</th>
                </tr>
            </thead>
            <tbody>
            {% for pred in blockchain_predictions|reverse %}
                <!-- 1-Day Row -->
                {% set row_class = 'success' if pred.mape_1d and pred.mape_1d < 2 else 'warning' if pred.mape_1d and pred.mape_1d < 5 else 'error' if pred.mape_1d else 'pending' %}
                <tr class="{{ row_class }}">
                    <td>{{ pred.date }}</td>
                    <td class="horizon"><strong>1-Day</strong></td>
                    <td>${{ "{:,.2f}".format(pred.current_price) }}</td>
                    <td>${{ "{:,.2f}".format(pred.pred_1d) }}</td>
                    <td>
                        {% if pred.actual_1d and not (pred.actual_1d != pred.actual_1d) %}
                            ${{ "{:,.2f}".format(pred.actual_1d) }}
                        {% else %}
                            <span class="pending">Pending...</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if pred.error_1d and not (pred.error_1d != pred.error_1d) %}
                            ${{ "{:,.2f}".format(pred.error_1d) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if pred.mape_1d and not (pred.mape_1d != pred.mape_1d) %}
                            {{ "%.2f"|format(pred.mape_1d) }}%
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="direction">
                        {% if pred.direction_correct_1d == 1 or pred.direction_correct_1d == True %}
                            <span class="correct">‚úì</span>
                        {% elif pred.direction_correct_1d == 0 or pred.direction_correct_1d == False %}
                            <span class="incorrect">‚úó</span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="tx-hash">
                        <a href="https://moonbase.moonscan.io/tx/{{ pred.tx_hash }}" target="_blank" title="{{ pred.tx_hash }}">
                            {{ pred.tx_hash[:10] }}...
                        </a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<!-- Chart Section -->
<section class="chart-section">
    <h2>üìà Predicted vs Actual Prices (Last 30 Days)</h2>
    <canvas id="predictionChart" width="400" height="150"></canvas>
</section>

<!-- Blockchain Verification Panel -->
<section class="blockchain-info">
    <h2>‚õìÔ∏è Blockchain Verification</h2>
    <div class="info-grid">
        <div class="info-card">
            <div class="info-label">Smart Contract</div>
            <div class="info-value">
                <a href="https://moonbase.moonscan.io/address/{{ contract_address }}" target="_blank">
                    {{ contract_address[:10] }}...{{ contract_address[-8:] }}
                </a>
            </div>
        </div>
        <div class="info-card">
            <div class="info-label">Network</div>
            <div class="info-value">Moonbase Alpha (Testnet)</div>
        </div>
        <div class="info-card">
            <div class="info-label">Total Gas Used</div>
            <div class="info-value">
                {% set total_gas = blockchain_predictions|sum(attribute='gas_used', start=0) %}
                {{ "{:,}".format(total_gas|int) }}
            </div>
        </div>
        <div class="info-card">
            <div class="info-label">Explorer</div>
            <div class="info-value">
                <a href="https://moonbase.moonscan.io" target="_blank">Moonscan</a>
            </div>
        </div>
    </div>
</section>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Fetch blockchain data and render chart
fetch('/api/blockchain-predictions')
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            const ctx = document.getElementById('predictionChart').getContext('2d');

            // Prepare data (filter predictions with actual data)
            const validPredictions = data.predictions.filter(p => p.actual_1d && !isNaN(p.actual_1d));
            const labels = validPredictions.map(p => p.date);
            const predicted = validPredictions.map(p => p.pred_1d);
            const actual = validPredictions.map(p => p.actual_1d);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Predicted (1d)',
                            data: predicted,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.1,
                            pointRadius: 4
                        },
                        {
                            label: 'Actual',
                            data: actual,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1,
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '1-Day Predictions vs Reality',
                            font: { size: 16 }
                        },
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Price (USD)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
        }
    })
    .catch(err => console.error('Error loading chart:', err));
</script>

{% endblock %}
