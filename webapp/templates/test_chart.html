<!DOCTYPE html>
<html>
<head>
    <title>Chart Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #chartContainer { background: white; padding: 20px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        canvas { max-height: 400px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>üìà Chart.js Test - Predicted vs Actual</h1>
    <div id="status"></div>
    <div id="chartContainer">
        <h2>Predicted vs Actual Prices (Last 30 Days)</h2>
        <canvas id="predictionChart" width="400" height="150"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        const statusDiv = document.getElementById('status');
        
        function showStatus(message, isError = false) {
            statusDiv.innerHTML = `<div class="status ${isError ? 'error' : 'success'}">${message}</div>`;
            console.log(message);
        }
        
        showStatus('Loading data from API...');
        
        fetch('http://localhost:5002/api/blockchain-predictions')
            .then(res => {
                console.log('Response status:', res.status);
                return res.json();
            })
            .then(data => {
                console.log('API Response:', data);
                console.log('Total predictions:', data.predictions ? data.predictions.length : 0);
                
                if (data.status === 'success') {
                    const ctx = document.getElementById('predictionChart');
                    if (!ctx) {
                        showStatus('‚ùå Canvas element not found!', true);
                        return;
                    }
                    
                    // Prepare data (filter predictions with actual data)
                    const validPredictions = data.predictions.filter(p => {
                        const hasActual = p.actual_1d != null && p.actual_1d !== '' && !isNaN(parseFloat(p.actual_1d));
                        console.log(`Prediction ${p.date}: actual_1d = ${p.actual_1d}, valid = ${hasActual}`);
                        return hasActual;
                    });
                    
                    console.log('Valid predictions for chart:', validPredictions.length);
                    showStatus(`‚úÖ Found ${validPredictions.length} valid predictions with outcomes`);
                    
                    if (validPredictions.length === 0) {
                        ctx.parentElement.innerHTML = '<p style="text-align:center; color:#666; padding:2rem;">No predictions with outcomes available yet. Check back soon!</p>';
                        return;
                    }
                    
                    const labels = validPredictions.map(p => p.date);
                    const predicted = validPredictions.map(p => parseFloat(p.pred_1d));
                    const actual = validPredictions.map(p => parseFloat(p.actual_1d));

                    console.log('Chart data prepared:', { labels: labels.length, predicted: predicted.length, actual: actual.length });
                    console.log('Sample data:', { 
                        date: labels[0], 
                        pred: predicted[0], 
                        actual: actual[0] 
                    });

                    new Chart(ctx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Predicted (1d)',
                                    data: predicted,
                                    borderColor: 'rgb(75, 192, 192)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                    tension: 0.1,
                                    pointRadius: 4
                                },
                                {
                                    label: 'Actual',
                                    data: actual,
                                    borderColor: 'rgb(255, 99, 132)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    tension: 0.1,
                                    pointRadius: 4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: '1-Day Predictions vs Reality',
                                    font: { size: 16 }
                                },
                                legend: {
                                    position: 'top'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    title: {
                                        display: true,
                                        text: 'Price (USD)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value.toLocaleString();
                                        }
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Date'
                                    }
                                }
                            }
                        }
                    });
                    
                    showStatus(`‚úÖ Chart created successfully with ${validPredictions.length} data points!`);
                    console.log('Chart created successfully!');
                } else {
                    showStatus('‚ùå API returned error status: ' + data.status, true);
                    console.error('API returned error status:', data);
                }
            })
            .catch(err => {
                showStatus('‚ùå Error loading chart: ' + err.message, true);
                console.error('Error loading chart:', err);
                const canvas = document.getElementById('predictionChart');
                if (canvas && canvas.parentElement) {
                    canvas.parentElement.innerHTML = '<p style="text-align:center; color:#dc3545; padding:2rem;">‚ùå Error loading chart data. Please refresh the page.</p>';
                }
            });
    </script>
</body>
</html>
